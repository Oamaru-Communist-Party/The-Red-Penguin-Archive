const repoOwner = "oamaru-communist-party";
const repoName = "The-Red-Penguin-Archive";

async function fetchEntries() {
    const apiURL = `https://api.github.com/repos/${repoOwner}/${repoName}/issues?state=open&per_page=100`;

    try {
        const response = await fetch(apiURL);
        const issues = await response.json();

        // Convert issues â†’ entries
        return issues.map(issue => {
            const body = issue.body || "";
            
            // Extract Description:
            const descMatch = body.match(/Description\s*\n(.+)/i);
            const description = descMatch ? descMatch[1].trim() : "No description.";

            // Extract Tags:
            const tagMatch = body.match(/Tags\s*\n(.+)/i);
            const tags = tagMatch ? tagMatch[1].split(",").map(t => t.trim()) : [];

            return {
                title: issue.title,
                description,
                tags,
                link: issue.html_url
            };
        });

    } catch (err) {
        console.error("Error fetching entries:", err);
        return [];
    }
}

async function displayEntries(entries) {
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

    if (entries.length === 0) {
        resultsDiv.innerHTML = "<p>No entries found.</p>";
        return;
    }

    entries.forEach(entry => {
        const card = document.createElement("div");
        card.style.marginBottom = "20px";
        card.style.padding = "10px";
        card.style.border = "1px solid #ccc";
        card.style.borderRadius = "8px";

        card.innerHTML = `
            <h2>${entry.title}</h2>
            <p>${entry.description}</p>
            <p><strong>Tags:</strong> ${entry.tags.join(", ")}</p>
            <a href="${entry.link}" target="_blank">Open</a>
        `;

        resultsDiv.appendChild(card);
    });
}

let allEntries = [];

// Search function
async function performSearch() {
    const query = document.getElementById("searchBar").value.toLowerCase();

    const filtered = allEntries.filter(entry =>
        entry.title.toLowerCase().includes(query) ||
        entry.description.toLowerCase().includes(query) ||
        entry.tags.join(" ").toLowerCase().includes(query)
    );

    displayEntries(filtered);
}

// Load entries when page loads
window.onload = async () => {
    allEntries = await fetchEntries();
    displayEntries(allEntries);
};
