name: Process Approved Submissions

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: read

jobs:
  add_to_index:
    # only run when the applied label name exactly equals "Approved"
    if: ${{ github.event.label.name == 'Approved' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue data
        id: extract
        run: |
          # convert the whole event to JSON and parse fields with jq
          ISSUE_JSON='${{ toJson(github.event) }}'
          TITLE=$(jq -r '.issue.title' <<< "$ISSUE_JSON")
          BODY=$(jq -r '.issue.body' <<< "$ISSUE_JSON")
          NUMBER=$(jq -r '.issue.number' <<< "$ISSUE_JSON")

          # expose as outputs for later steps
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT
          echo "number=$NUMBER" >> $GITHUB_OUTPUT

      - name: Create entry page and update index.json
        run: |
          set -euo pipefail

          TITLE="${{ steps.extract.outputs.title }}"
          BODY="${{ steps.extract.outputs.body }}"
          NUMBER="${{ steps.extract.outputs.number }}"

          mkdir -p entries

          # create the entry HTML page (safe substitution via bash vars)
          cat > "entries/entry-${NUMBER}.html" <<EOF
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>${TITLE}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .banner { background: #c62828; color: white; padding: 15px; font-size: 20px; margin-bottom: 30px; }
    .entry { max-width: 820px; }
  </style>
</head>
<body>
  <div class="banner">The Red Penguin Archive â€” Entry</div>

  <div class="entry">
    <h1>${TITLE}</h1>
    <div>
      <pre style="white-space: pre-wrap; font-family: inherit;">${BODY}</pre>
    </div>

    <p><b>Original issue:</b>
      <a href="https://github.com/oamaru-communist-party/The-Red-Penguin-Archive/issues/${NUMBER}">
        View original issue #${NUMBER}
      </a>
    </p>
  </div>
</body>
</html>
EOF

          # compute the public page URL that will exist under GitHub Pages
          PAGE_URL="https://oamaru-communist-party.github.io/The-Red-Penguin-Archive/entries/entry-${NUMBER}.html"

          # create a JSON object for the index (jq produces a safe JSON value)
          NEW_ENTRY=$(jq -n \
            --arg title "$TITLE" \
            --arg description "$BODY" \
            --arg link "$PAGE_URL" \
            '{title: $title, description: $description, tags: [], link: $link}')

          # ensure index.json exists and is valid array; if not, create a new one
          if [ ! -f index.json ] || ! jq -e . >/dev/null 2>&1 < index.json; then
            echo "[]" > index.json
          fi

          # append the new entry to the array in index.json
          jq ". + [ $NEW_ENTRY ]" index.json > index_new.json
          mv index_new.json index.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add entries index.json
          # if nothing changed, skip commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add approved entry from issue #${{ steps.extract.outputs.number }}"
            git push
          fi
