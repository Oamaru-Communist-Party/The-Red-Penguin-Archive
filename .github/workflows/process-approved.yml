name: Process Approved Submissions

on:
  issues:
    types: [labeled]

jobs:
  add_to_index:
    if: github.event.label.name == 'Approved'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Extract issue data
        id: extract
        shell: bash
        run: |
          echo "title=$(jq -r '.issue.title' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT
          echo "body=$(jq -r '.issue.body' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT
          echo "number=$(jq -r '.issue.number' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT

      - name: Create entry page
        shell: bash
        run: |
          mkdir -p entries

          cat << 'EOF' > entries/entry-${{ steps.extract.outputs.number }}.html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${{ steps.extract.outputs.title }}</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    .banner { 
      background: #c62828; 
      color: white; 
      padding: 15px; 
      font-size: 20px;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div class="banner">The Red Penguin Archive â€” Entry</div>

  <h1>${{ steps.extract.outputs.title }}</h1>

  <p>${{ steps.extract.outputs.body }}</p>

  <p><b>Issue Link:</b>
    <a href="https://github.com/oamaru-communist-party/The-Red-Penguin-Archive/issues/${{ steps.extract.outputs.number }}">
      View Original Issue
    </a>
  </p>

</body>
</html>
EOF

      - name: Append entry to index.json
        shell: bash
        run: |
          page="https://oamaru-communist-party.github.io/The-Red-Penguin-Archive/entries/entry-${{ steps.extract.outputs.number }}.html"

          entry=$(jq -n \
            --arg title "${{ steps.extract.outputs.title }}" \
            --arg description "${{ steps.extract.outputs.body }}" \
            --arg link "$page" \
            '{title: $title, description: $description, tags: [], link: $link}')

          jq ". + [${entry}]" index.json > new.json
          mv new.json index.json

      - name: Commit update
        shell: bash
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add entries index.json
          git commit -m "Add approved entry: #${{ steps.extract.outputs.number }}" || echo "No changes to commit"
          git push
