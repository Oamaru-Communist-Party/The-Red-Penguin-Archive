name: Process Approved Submissions

on:
  issues:
    types: [labeled]

jobs:
  add_to_index:
    # only run when the label added is "Approved"
    if: ${{ github.event.label.name == 'Approved' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Extract issue data
        id: extract
        run: |
          echo "title=$(jq -r '.issue.title' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT
          echo "body=$(jq -r '.issue.body' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT
          echo "number=$(jq -r '.issue.number' <<< '${{ toJson(github.event) }}')" >> $GITHUB_OUTPUT

      - name: Create entry page
        run: |
          mkdir -p entries
          cat > "entries/entry-${{ steps.extract.outputs.number }}.html" <<'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${{ steps.extract.outputs.title }}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .banner { 
      background: #c62828; 
      color: white; 
      padding: 15px; 
      font-size: 20px;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div class="banner">The Red Penguin Archive â€” Entry</div>

  <h1>${{ steps.extract.outputs.title }}</h1>

  <div>
    ${{ steps.extract.outputs.body }}
  </div>

  <p><b>Original Issue:</b>
    <a href="https://github.com/${{ github.repository }}/issues/${{ steps.extract.outputs.number }}">
      View on GitHub
    </a>
  </p>

</body>
</html>
EOF

      - name: Append entry to index.json
        run: |
          page="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/entries/entry-${{ steps.extract.outputs.number }}.html"

          entry=$(jq -n \
            --arg title "${{ steps.extract.outputs.title }}" \
            --arg description "${{ steps.extract.outputs.body }}" \
            --arg link "$page" \
            '{title: $title, description: $description, tags: [], link: $link}')

          jq ". + [${entry}]" index.json > new.json
          mv new.json index.json

      - name: Commit update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add entries index.json
          git commit -m "Add Approved entry: #${{ steps.extract.outputs.number }}" || echo "No changes to commit"
          git push

