name: Process Approved Submissions

on:
  issues:
    types: [labeled]

jobs:
  add_to_index:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Build entry JSON safely
        id: entry
        run: |
          title="${{ github.event.issue.title }}"
          body="${{ github.event.issue.body }}"
          url="${{ github.event.issue.html_url }}"

          # Build JSON entry safely using jq â€” no shell escaping problems
          echo "$(jq -n \
            --arg title "$title" \
            --arg description "$body" \
            --arg link "$url" \
            '{title: $title, description: $description, tags: [], link: $link}')" \
            > entry.json

      - name: Append entry to index.json
        run: |
          jq ". + [$(cat entry.json)]" index.json > new.json
          mv new.json index.json

      - name: Commit update
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add index.json
          git commit -m "Add approved submission: ${{ github.event.issue.title }}" || echo "No changes"
          git push
