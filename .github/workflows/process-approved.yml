name: Process Approved Submissions

on:
  issues:
    types: [labeled]

jobs:
  add_to_index:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Capture issue fields safely
        id: extract
        shell: bash
        run: |
          TITLE=$(jq -r '.issue.title' <<< '${{ toJson(github.event) }}')
          BODY=$(jq -r '.issue.body' <<< '${{ toJson(github.event) }}')
          URL=$(jq -r '.issue.html_url' <<< '${{ toJson(github.event) }}')

          # Escape newlines for JSON safety
          BODY_ESCAPED=$(printf '%s' "$BODY" | jq -Rs .)

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body_escaped=$BODY_ESCAPED" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Append entry to index.json
        shell: bash
        run: |
          jq --arg title "${{ steps.extract.outputs.title }}" \
             --argjson body "${{ steps.extract.outputs.body_escaped }}" \
             --arg link "${{ steps.extract.outputs.url }}" \
             '. += [{ title: $title, description: $body, tags: [], link: $link }]' \
             index.json > new.json

          mv new.json index.json

      - name: Commit update
        shell: bash
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add index.json
          git commit -m "Add approved submission: ${{ steps.extract.outputs.title }}"
          git push
