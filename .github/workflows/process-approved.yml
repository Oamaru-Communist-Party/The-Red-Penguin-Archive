name: Process Approved Submissions

on:
  issues:
    types: [labeled]

jobs:
  add_to_index:
    if: ${{ github.event.label.name == 'approved' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read issue fields into variables
        id: read
        run: |
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          NUMBER="${{ github.event.issue.number }}"
          echo "TITLE<<EOF" >> $GITHUB_OUTPUT
          echo "${TITLE}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "BODY<<EOF" >> $GITHUB_OUTPUT
          echo "${BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "NUMBER=${NUMBER}" >> $GITHUB_OUTPUT

      - name: Create entry page and update index.json
        run: |
          set -e

          # prepare variables
          TITLE=$(jq -R -r . <<< "${{ steps.read.outputs.TITLE }}")
          BODY=$(jq -R -r . <<< "${{ steps.read.outputs.BODY }}")
          NUMBER="${{ steps.read.outputs.NUMBER }}"

          # ensure folder
          mkdir -p entries

          # create HTML page (note: EOF must be at start of line)
          cat > "entries/entry-${NUMBER}.html" <<EOF
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${TITLE}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .banner { 
      background: #c62828; 
      color: white; 
      padding: 15px; 
      font-size: 20px;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div class="banner">The Red Penguin Archive â€” Entry</div>

  <h1>${TITLE}</h1>

  <div>
${BODY}
  </div>

  <p><b>Original Issue:</b>
    <a href="https://github.com/${{ github.repository }}/issues/${NUMBER}">
      View Original Issue
    </a>
  </p>

</body>
</html>
EOF

          # create or update index.json by appending the new entry
          PAGE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/entries/entry-${NUMBER}.html"

          # Build a JSON object for the entry
          ENTRY_JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg description "$BODY" \
            --arg link "$PAGE_URL" \
            '{title: $title, description: $description, tags: [], link: $link}')

          # Ensure index.json exists and is an array; if not, create one
          if [ ! -f index.json ] || ! jq -e . index.json >/dev/null 2>&1; then
            echo '[]' > index.json
          fi

          jq ". + [${ENTRY_JSON}]" index.json > index_new.json
          mv index_new.json index.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add entries index.json
          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Add approved entry: #${{ steps.read.outputs.NUMBER }} - ${{ steps.read.outputs.TITLE }}"
            git push
          fi
